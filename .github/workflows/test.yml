name: Test

on:
  pull_request:
    branches: [master]

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-affected:
    runs-on: ubuntu-latest
    outputs:
      cli_startup: ${{ steps.affected.outputs.cli_startup }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-pnpm-node
      - id: smoke-affected
        uses: ./.github/actions/check-affected-target
        with:
          base-sha: ${{ github.event.pull_request.base.sha }}
          head-sha: ${{ github.event.pull_request.head.sha }}
          targets: build
          project-type: app
          include-projects: cli,server
      - id: affected
        shell: bash
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          BASE_AFFECTED: ${{ steps.smoke-affected.outputs.affected }}
        run: |
          set -euo pipefail

          changed="$(git diff --name-only --no-renames "${BASE_SHA}" "${HEAD_SHA}")"

          should_run="${BASE_AFFECTED}"

          # Always validate smoke test changes themselves.
          if echo "${changed}" | grep -Eq '^(\.github/workflows/test\.yml$|\.github/actions/setup-pnpm-node/|\.github/actions/check-affected-target/)'; then
            should_run="true"
          fi

          echo "cli_startup=${should_run}" >> "${GITHUB_OUTPUT}"

  cli-startup:
    needs: check-affected
    if: needs.check-affected.outputs.cli_startup == 'true'
    name: smoke - cli startup (${{ matrix.os_name }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 12
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_name: Linux
            runner: ubuntu-latest
            port: 6979
            log_file: /tmp/OpenKit-linux-smoke.log
          - os_name: macOS
            runner: macos-latest
            port: 6989
            log_file: /tmp/OpenKit-macos-smoke.log

    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-pnpm-node
      - run: pnpm run build:cli && pnpm run build:server
      - name: Smoke test CLI startup
        run: |
          set -euo pipefail
          export OPENKIT_NO_OPEN=1
          export OPENKIT_AUTO_INIT=1
          export OPENKIT_SERVER_PORT=${{ matrix.port }}

          node apps/cli/dist/cli/index.js --no-open > "${{ matrix.log_file }}" 2>&1 &
          OPENKIT_PID=$!

          cleanup() {
            kill "$OPENKIT_PID" 2>/dev/null || true
            wait "$OPENKIT_PID" 2>/dev/null || true
          }
          trap cleanup EXIT

          for i in $(seq 1 60); do
            if ! kill -0 "$OPENKIT_PID" 2>/dev/null; then
              echo "OpenKit process exited before startup completed"
              cat "${{ matrix.log_file }}" || true
              exit 1
            fi

            if curl --silent --fail "http://127.0.0.1:${OPENKIT_SERVER_PORT}/api/config" >/dev/null; then
              exit 0
            fi

            sleep 1
          done

          echo "OpenKit failed to become ready within timeout"
          cat "${{ matrix.log_file }}" || true
          exit 1
