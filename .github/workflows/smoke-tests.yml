name: Smoke Tests

on:
  pull_request:
    branches: [master]

concurrency:
  group: smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cli-startup:
    name: CLI startup (${{ matrix.os_name }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 12
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_name: Linux
            runner: ubuntu-latest
            port: 6979
            log_file: /tmp/OpenKit-linux-smoke.log
          - os_name: macOS
            runner: macos-latest
            port: 6989
            log_file: /tmp/OpenKit-macos-smoke.log

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-pnpm-node
      - run: pnpm run build:cli && pnpm run build:server
      - name: Smoke test CLI startup
        run: |
          set -euo pipefail
          export OPENKIT_NO_OPEN=1
          export OPENKIT_AUTO_INIT=1
          export OPENKIT_SERVER_PORT=${{ matrix.port }}

          node apps/cli/dist/cli/index.js --no-open > "${{ matrix.log_file }}" 2>&1 &
          OPENKIT_PID=$!

          cleanup() {
            kill "$OPENKIT_PID" 2>/dev/null || true
            wait "$OPENKIT_PID" 2>/dev/null || true
          }
          trap cleanup EXIT

          for i in $(seq 1 60); do
            if ! kill -0 "$OPENKIT_PID" 2>/dev/null; then
              echo "OpenKit process exited before startup completed"
              cat "${{ matrix.log_file }}" || true
              exit 1
            fi

            if curl --silent --fail "http://127.0.0.1:${OPENKIT_SERVER_PORT}/api/config" >/dev/null; then
              exit 0
            fi

            sleep 1
          done

          echo "OpenKit failed to become ready within timeout"
          cat "${{ matrix.log_file }}" || true
          exit 1
